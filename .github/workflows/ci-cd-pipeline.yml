# =============================================================================
# CI/CD Pipeline for Spring Boot 3.5.4 Application
# =============================================================================
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ì™„ì „ ìë™í™”ëœ CI/CD íŒŒì´í”„ë¼ì¸ì„ ì œê³µí•©ë‹ˆë‹¤:
# - ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° í…ŒìŠ¤íŠ¸
# - CDS ìµœì í™” Docker ì´ë¯¸ì§€ ë¹Œë“œ
# - AWS ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
# - CodeDeployë¥¼ í†µí•œ Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬
# - ìŠ¬ë™ ì•Œë¦¼ ë° ë¡¤ë°± ì§€ì›
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: [v*]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: iroom/spring-backend
  APPLICATION_NAME: iroom-backend
  DEPLOYMENT_GROUP: production
  JAVA_VERSION: '21'
  GRADLE_VERSION: '8.14.3'

jobs:
  # ==========================================================================
  # Code Quality & Testing
  # ==========================================================================
  test:
    name: ğŸ§ª Test & Quality Check
    runs-on: ubuntu-24.04
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'bellsoft'  # Liberica JDK

      - name: ğŸ“‹ Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”§ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ğŸ“Š Run tests and generate reports
        run: |
          ./gradlew clean test jacocoTestReport
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_HOST: localhost
          DB_PORT: 3306
          DB_NAME: test_db
          DB_USERNAME: test_user
          DB_PASSWORD: test_password
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: ğŸ“ˆ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/reports/tests/test/

      - name: ğŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: build/reports/jacoco/test/

      - name: ğŸ“‹ Comment test results on PR
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: 'Test Results'
          path: 'build/test-results/test/*.xml'
          reporter: java-junit

  # ==========================================================================
  # Build & Push Docker Image
  # ==========================================================================
  build:
    name: ğŸ”¨ Build & Push Image
    runs-on: ubuntu-24.04
    needs: test
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'bellsoft'

      - name: ğŸ“‹ Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ”¨ Build application
        run: |
          chmod +x gradlew
          ./gradlew clean bootJar
        env:
          SPRING_PROFILES_ACTIVE: production

      - name: ğŸ·ï¸ Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REPOSITORY }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=commit-

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build and push Docker image (CDS enabled)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.cds
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            JAR_FILE=build/libs/*.jar
            JAVA_OPTS=-Xms512m -Xmx1024m -XX:+UseG1GC

      - name: ğŸ“‹ Generate deployment manifest
        run: |
          cat > deployment-manifest.json << EOF
          {
            "imageUri": "${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}",
            "imageTag": "${{ steps.meta.outputs.version }}",
            "commitSha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "buildTime": "$(date -Iseconds)",
            "actor": "${{ github.actor }}"
          }
          EOF

      - name: ğŸ“¤ Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-manifest
          path: deployment-manifest.json

  # ==========================================================================
  # Deploy to Production
  # ==========================================================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: [self-hosted, production]
    needs: build
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: https://api.iroom.example.com

    steps:
      - name: ğŸ“¥ Download deployment manifest
        uses: actions/download-artifact@v4
        with:
          name: deployment-manifest

      - name: ğŸ“‹ Load deployment info
        id: deployment-info
        run: |
          IMAGE_URI=$(jq -r '.imageUri' deployment-manifest.json)
          IMAGE_TAG=$(jq -r '.imageTag' deployment-manifest.json)
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ“¥ Pull latest Docker image
        run: |
          docker pull ${{ steps.deployment-info.outputs.image-uri }}
          docker tag ${{ steps.deployment-info.outputs.image-uri }} iroom/spring-backend:latest
          docker tag ${{ steps.deployment-info.outputs.image-uri }} iroom/spring-backend:${{ steps.deployment-info.outputs.image-tag }}

      - name: ğŸš€ Execute Blue-Green deployment
        id: deploy
        run: |
          cd /opt/scripts
          ./blue-green-deploy.sh deploy ${{ steps.deployment-info.outputs.image-tag }}
        
      - name: ğŸ” Verify deployment
        run: |
          sleep 30
          curl -f http://localhost/api/system/health || exit 1
          echo "âœ… Deployment verification successful"

      - name: ğŸ§¹ Cleanup old images
        run: |
          # 3ê°œ ì´ì „ ë²„ì „ë§Œ ìœ ì§€
          docker images iroom/spring-backend --format "table {{.ID}}\t{{.Tag}}" | \
            tail -n +4 | head -n -3 | awk '{print $1}' | xargs -r docker rmi || true

  # ==========================================================================
  # Rollback (Manual Trigger)
  # ==========================================================================
  rollback:
    name: ğŸ”„ Rollback Deployment
    runs-on: [self-hosted, production]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'rollback'
    
    steps:
      - name: ğŸ”„ Execute rollback
        run: |
          cd /opt/scripts
          ./blue-green-deploy.sh rollback

      - name: ğŸ” Verify rollback
        run: |
          sleep 15
          curl -f http://localhost/api/system/health || exit 1
          echo "âœ… Rollback verification successful"

  # ==========================================================================
  # Notifications
  # ==========================================================================
  notify:
    name: ğŸ“¢ Send Notifications
    runs-on: ubuntu-24.04
    needs: [test, build, deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Slack notification - Success
        if: needs.deploy.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            ğŸ‰ *Deployment Successful*
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ·ï¸ Version: ${{ needs.build.outputs.image-tag }}
            ğŸ‘¤ Deployed by: ${{ github.actor }}
            ğŸŒ Environment: Production
            
            âœ… All services are healthy
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“¢ Slack notification - Failure
        if: needs.deploy.result == 'failure' || needs.build.result == 'failure' || needs.test.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: |
            ğŸš¨ *Deployment Failed*
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸŒ Environment: Production
            
            âŒ Please check the workflow logs
            ğŸ”„ Consider running rollback if needed
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“Š Update deployment status
        if: always()
        run: |
          STATUS="${{ needs.deploy.result }}"
          if [ "$STATUS" = "success" ]; then
            echo "âœ… Deployment completed successfully"
          else
            echo "âŒ Deployment failed with status: $STATUS"
          fi