# =============================================================================
# Manual Rollback Workflow
# =============================================================================
# ì‘ê¸‰ ìƒí™©ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ëŠ” ì›Œí¬í”Œë¡œìš°
# - Blue-Green í™˜ê²½ ê°„ ì¦‰ì‹œ ì „í™˜
# - í—¬ìŠ¤ì²´í¬ ë° ê²€ì¦
# - ìŠ¬ë™ ì•Œë¦¼
# =============================================================================

name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        default: 'ì‘ê¸‰ ë¡¤ë°±'
      skip_health_check:
        description: 'í—¬ìŠ¤ì²´í¬ ê±´ë„ˆë›°ê¸°'
        required: false
        default: 'false'
        type: boolean

jobs:
  rollback:
    name: ğŸ”„ Execute Rollback
    runs-on: [self-hosted, production]
    
    steps:
      - name: ğŸ“‹ Rollback ì •ë³´ ì¶œë ¥
        run: |
          echo "ğŸ”„ ë¡¤ë°± ì‹¤í–‰ ì •ë³´:"
          echo "  â€¢ ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo "  â€¢ ì‹¤í–‰ì: ${{ github.actor }}"
          echo "  â€¢ ì‹œê°„: $(date)"
          echo "  â€¢ í—¬ìŠ¤ì²´í¬ ê±´ë„ˆë›°ê¸°: ${{ github.event.inputs.skip_health_check }}"

      - name: ğŸ“Š í˜„ì¬ ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          echo "=== í˜„ì¬ ë°°í¬ ìƒíƒœ ==="
          /opt/scripts/blue-green-deploy.sh status

      - name: ğŸ”„ ë¡¤ë°± ì‹¤í–‰
        id: rollback
        run: |
          cd /opt/scripts
          if ./blue-green-deploy.sh rollback; then
            echo "rollback-status=success" >> $GITHUB_OUTPUT
          else
            echo "rollback-status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ” ë¡¤ë°± ê²€ì¦
        if: github.event.inputs.skip_health_check != 'true'
        run: |
          echo "ë¡¤ë°± ê²€ì¦ ì‹œì‘..."
          sleep 15
          
          # í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
          for i in {1..10}; do
            if curl -f -s http://localhost/api/system/health > /dev/null; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„: $i/10)"
              break
            fi
            
            if [ $i -eq 10 ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
              exit 1
            fi
            
            echo "â³ í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ì¤‘... ($i/10)"
            sleep 10
          done

      - name: ğŸ“Š ë¡¤ë°± í›„ ìƒíƒœ í™•ì¸
        run: |
          echo "=== ë¡¤ë°± í›„ ë°°í¬ ìƒíƒœ ==="
          /opt/scripts/blue-green-deploy.sh status
          
          echo
          echo "=== ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ==="
          /opt/scripts/health-check.sh

  notify:
    name: ğŸ“¢ Send Notification
    runs-on: ubuntu-24.04
    needs: rollback
    if: always()
    
    steps:
      - name: ğŸ“¢ Slack ì•Œë¦¼ - ë¡¤ë°± ì„±ê³µ
        if: needs.rollback.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            ğŸ”„ *Rollback Completed Successfully*
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ‘¤ Executed by: ${{ github.actor }}
            ğŸ“ Reason: ${{ github.event.inputs.reason }}
            â° Time: $(date)
            
            âœ… Previous version is now active
            ğŸ” Please verify the application functionality
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“¢ Slack ì•Œë¦¼ - ë¡¤ë°± ì‹¤íŒ¨
        if: needs.rollback.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: |
            ğŸš¨ *Rollback Failed*
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ‘¤ Executed by: ${{ github.actor }}
            ğŸ“ Reason: ${{ github.event.inputs.reason }}
            
            âŒ Rollback failed - Manual intervention required
            ğŸ“ Please contact the DevOps team immediately
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}