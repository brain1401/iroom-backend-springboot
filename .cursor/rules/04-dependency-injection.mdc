---
description: ìƒì„±ì ì£¼ì… ë° ì˜ì¡´ì„± ê´€ë¦¬ íŒ¨í„´
globs: **/controller/*.java, **/service/*.java, **/config/*.java
alwaysApply: false
---

# ì˜ì¡´ì„± ì£¼ì… íŒ¨í„´

## ğŸ¯ ì˜ì¡´ì„± ì£¼ì… ì›ì¹™

### ìƒì„±ì ì£¼ì… (Constructor Injection) í•„ìˆ˜
- **@RequiredArgsConstructor** í™œìš©
- **final** í‚¤ì›Œë“œë¡œ ë¶ˆë³€ì„± ë³´ì¥
- **í•„ë“œ ì£¼ì… ê¸ˆì§€** (@Autowired ì‚¬ìš© ê¸ˆì§€)

### ì˜ì¡´ì„± ì—­ì „ ì›ì¹™ (DIP) ì¤€ìˆ˜
- ì¶”ìƒí™”(ì¸í„°í˜ì´ìŠ¤)ì— ì˜ì¡´
- êµ¬ì²´ í´ë˜ìŠ¤ê°€ ì•„ë‹Œ ì¶”ìƒí™”ì— ì˜ì¡´

## ğŸ—ï¸ Controller ê³„ì¸µ íŒ¨í„´

### âœ… í‘œì¤€ Controller êµ¬ì¡°
```java
/**
 * ì‚¬ìš©ì ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
 * 
 * í•™ìƒ ë¡œê·¸ì¸, ì •ë³´ ì¡°íšŒ ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
 */
@RestController
@RequestMapping("/api/users")
@RequiredArgsConstructor  // Lombokìœ¼ë¡œ ìƒì„±ì ìë™ ìƒì„±
@Tag(name = "ì‚¬ìš©ì API", description = "ì‚¬ìš©ì ê´€ë¦¬ ê´€ë ¨ API")
@Validated
public class UserController {
    
    // finalë¡œ ë¶ˆë³€ì„± ë³´ì¥
    private final UserService userService;
    
    /**
     * ì‚¬ìš©ì ë¡œê·¸ì¸
     */
    @PostMapping("/login")
    @Operation(summary = "ì‚¬ìš©ì ë¡œê·¸ì¸", description = "ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤")
    public ApiResponse<UserLoginResponse> login(
            @Valid @RequestBody UserLoginRequest request) {
        
        UserLoginResponse response = userService.login(request);
        return ApiResponse.success("ë¡œê·¸ì¸ ì„±ê³µ", response);
    }
}
```

### âœ… ë‹¤ì¤‘ ì˜ì¡´ì„± ì£¼ì…
```java
/**
 * ì‹œí—˜ ë‹µì•ˆ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
 */
@RestController
@RequestMapping("/api/exam-answers")
@RequiredArgsConstructor
@Tag(name = "ì‹œí—˜ ë‹µì•ˆ API", description = "ë‹µì•ˆ ì œì¶œ ë° ê´€ë¦¬ API")
public class ExamAnswerController {
    
    // ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ì£¼ì…
    private final ExamAnswerService examAnswerService;
    private final ExamSubmissionService examSubmissionService;
    private final AiImageRecognitionService aiImageRecognitionService;
    
    /**
     * ë‹µì•ˆ ìƒì„± (AI ì¸ì‹ í¬í•¨)
     */
    @PostMapping
    public ApiResponse<ExamAnswerResponse> createAnswer(
            @Valid @RequestBody ExamAnswerCreateRequest request) {
        
        ExamAnswerResponse response = examAnswerService.createExamAnswer(request);
        return ApiResponse.success("ë‹µì•ˆ ìƒì„± ì„±ê³µ", response);
    }
}
```

## ğŸ”§ Service ê³„ì¸µ íŒ¨í„´

### âœ… í‘œì¤€ Service êµ¬ì¡°
```java
/**
 * ì‚¬ìš©ì ê´€ë¦¬ ì„œë¹„ìŠ¤
 * 
 * ì‚¬ìš©ì ë¡œê·¸ì¸, ì •ë³´ ê´€ë¦¬ ë“±ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 */
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)  // ê¸°ë³¸ì ìœ¼ë¡œ ì½ê¸° ì „ìš©
public class UserService {
    
    // Repository ì˜ì¡´ì„± ì£¼ì…
    private final UserRepository userRepository;
    
    /**
     * ì‚¬ìš©ì ë¡œê·¸ì¸ ì²˜ë¦¬
     */
    public UserLoginResponse login(UserLoginRequest request) {
        log.info("ì‚¬ìš©ì ë¡œê·¸ì¸ ìš”ì²­: ì´ë¦„={}, ì „í™”ë²ˆí˜¸={}", 
                request.name(), request.phone());
        
        User user = userRepository.findByNameAndPhone(request.name(), request.phone())
            .orElseThrow(() -> new IllegalArgumentException(
                "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•™ìƒì…ë‹ˆë‹¤. ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."));
        
        log.info("ì‚¬ìš©ì ë¡œê·¸ì¸ ì„±ê³µ: ID={}, ì´ë¦„={}", user.getId(), user.getName());
        
        return new UserLoginResponse(
            user.getId(),
            user.getName(),
            user.getPhone(),
            "ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤."
        );
    }
}
```

### âœ… ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™ íŒ¨í„´
```java
/**
 * AI ì´ë¯¸ì§€ ì¸ì‹ ì„œë¹„ìŠ¤
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class AiImageRecognitionService {
    
    // ì™¸ë¶€ ì„œë¹„ìŠ¤ í†µì‹ ì„ ìœ„í•œ RestTemplate ì£¼ì…
    private final RestTemplate restTemplate;
    // ì„¤ì •ê°’ ì£¼ì…
    @Value("${ai.server.url}")
    private final String aiServerUrl;
    @Value("${ai.server.timeout:5000}")
    private final int timeoutMs;
    
    /**
     * ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¸ì‹
     */
    public AiRecognitionResult recognizeTextFromImage(String imageUrl) {
        log.info("AI ì´ë¯¸ì§€ ì¸ì‹ ì‹œì‘: ì´ë¯¸ì§€ URL={}", imageUrl);
        
        try {
            String requestUrl = aiServerUrl + "/recognize";
            AiRecognitionRequest request = new AiRecognitionRequest(imageUrl);
            
            AiRecognitionResult result = restTemplate.postForObject(
                requestUrl, request, AiRecognitionResult.class);
            
            log.info("AI ì´ë¯¸ì§€ ì¸ì‹ ì™„ë£Œ: ì¸ì‹ ê²°ê³¼={}", result.getRecognizedText());
            return result;
            
        } catch (Exception e) {
            log.error("AI ì´ë¯¸ì§€ ì¸ì‹ ì‹¤íŒ¨: ì´ë¯¸ì§€ URL={}, ì˜¤ë¥˜={}", 
                     imageUrl, e.getMessage(), e);
            throw new AiRecognitionException("AI ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
        }
    }
}
```

### âœ… ì„œë¹„ìŠ¤ ê°„ ì˜ì¡´ì„± íŒ¨í„´
```java
/**
 * ì‹œí—˜ ë‹µì•ˆ ê´€ë¦¬ ì„œë¹„ìŠ¤
 */
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class ExamAnswerService {
    
    // Repository ì˜ì¡´ì„±
    private final ExamAnswerRepository examAnswerRepository;
    private final ExamSubmissionRepository examSubmissionRepository;
    private final QuestionRepository questionRepository;
    
    // ë‹¤ë¥¸ Service ì˜ì¡´ì„± (DTO í†µì‹ )
    private final AiImageRecognitionService aiImageRecognitionService;
    
    /**
     * ë‹µì•ˆ ìƒì„± (AI ì¸ì‹ í¬í•¨)
     */
    @Transactional
    public ExamAnswerResponse createExamAnswer(ExamAnswerCreateRequest request) {
        log.info("ë‹µì•ˆ ìƒì„± ìš”ì²­: ì œì¶œ ID={}, ë¬¸ì œ ID={}", 
                request.examSubmissionId(), request.questionId());
        
        // 1ë‹¨ê³„: ì—”í‹°í‹° ì¡°íšŒ ë° ê²€ì¦
        ExamSubmission submission = findExamSubmissionById(request.examSubmissionId());
        Question question = findQuestionById(request.questionId());
        
        // 2ë‹¨ê³„: ë‹µì•ˆ ìƒì„±
        ExamAnswer answer = createAnswerEntity(submission, question, request);
        ExamAnswer savedAnswer = examAnswerRepository.save(answer);
        
        // 3ë‹¨ê³„: AI ì„œë¹„ìŠ¤ í˜¸ì¶œ (ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ í†µì‹ )
        processAiRecognition(savedAnswer, request.answerImageUrl());
        
        return ExamAnswerResponse.from(savedAnswer);
    }
    
    private void processAiRecognition(ExamAnswer answer, String imageUrl) {
        try {
            // ë‹¤ë¥¸ ì„œë¹„ìŠ¤ í˜¸ì¶œ
            AiRecognitionResult result = aiImageRecognitionService
                .recognizeTextFromImage(imageUrl);
            
            answer.updateAnswerText(result.getRecognizedText());
            examAnswerRepository.save(answer);
            
        } catch (Exception e) {
            log.error("AI ì¸ì‹ ì‹¤íŒ¨: ë‹µì•ˆ ID={}", answer.getId(), e);
            // AI ì‹¤íŒ¨í•´ë„ ë‹µì•ˆì€ ì €ì¥ëœ ìƒíƒœë¡œ ìœ ì§€
        }
    }
}
```

## âš™ï¸ Configuration ê³„ì¸µ íŒ¨í„´

### âœ… Bean ì •ì˜ ë° ì£¼ì…
```java
/**
 * ì›¹ ì„¤ì • êµ¬ì„±
 */
@Configuration
@RequiredArgsConstructor
public class WebConfig {
    
    /**
     * RestTemplate Bean ì •ì˜
     */
    @Bean
    public RestTemplate restTemplate() {
        RestTemplate restTemplate = new RestTemplate();
        
        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(5000);
        factory.setReadTimeout(10000);
        restTemplate.setRequestFactory(factory);
        
        return restTemplate;
    }
    
    /**
     * ObjectMapper ì»¤ìŠ¤í„°ë§ˆì´ì§•
     */
    @Bean
    @Primary
    public ObjectMapper objectMapper() {
        return new ObjectMapper()
            .registerModule(new JavaTimeModule())
            .disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)
            .setPropertyNamingStrategy(PropertyNamingStrategies.SNAKE_CASE);
    }
}
```

### âœ… ì¡°ê±´ë¶€ Bean ìƒì„±
```java
/**
 * ê°œë°œ/ìš´ì˜ í™˜ê²½ë³„ ì„¤ì •
 */
@Configuration
public class EnvironmentConfig {
    
    /**
     * ê°œë°œ í™˜ê²½ìš© Bean
     */
    @Bean
    @Profile("dev")
    public DataSource devDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("jdbc:mysql://localhost:3306/iroom_dev");
        dataSource.setUsername("dev_user");
        dataSource.setPassword("dev_password");
        return dataSource;
    }
    
    /**
     * ìš´ì˜ í™˜ê²½ìš© Bean
     */
    @Bean
    @Profile("prod")
    public DataSource prodDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl("${database.url}");
        dataSource.setUsername("${database.username}");
        dataSource.setPassword("${database.password}");
        dataSource.setMaximumPoolSize(20);
        return dataSource;
    }
}
```

## âŒ í”¼í•´ì•¼ í•  íŒ¨í„´

### âŒ í•„ë“œ ì£¼ì… ì‚¬ìš© ê¸ˆì§€
```java
// ì˜ëª»ëœ ë°©ì‹ - ì‚¬ìš© ê¸ˆì§€
@RestController
public class UserController {
    
    @Autowired
    private UserService userService;  // í•„ë“œ ì£¼ì… ê¸ˆì§€!
    
    @Autowired
    private ExamService examService;  // í•„ë“œ ì£¼ì… ê¸ˆì§€!
}
```

### âŒ Setter ì£¼ì… ì§€ì–‘
```java
// ì§€ì–‘í•˜ëŠ” ë°©ì‹
@Service
public class UserService {
    
    private UserRepository userRepository;
    
    @Autowired
    public void setUserRepository(UserRepository userRepository) {
        this.userRepository = userRepository;  // Setter ì£¼ì… ì§€ì–‘
    }
}
```

### âŒ ìˆœí™˜ ì˜ì¡´ì„±
```java
// ë¬¸ì œê°€ ìˆëŠ” êµ¬ì¡°
@Service
public class UserService {
    private final ExamService examService;  // ExamServiceê°€ UserServiceë¥¼ ì˜ì¡´í•˜ë©´ ìˆœí™˜ ì˜ì¡´ì„±
}

@Service  
public class ExamService {
    private final UserService userService;  // ìˆœí™˜ ì˜ì¡´ì„± ë°œìƒ!
}
```

## ğŸ” ì˜ì¡´ì„± ì£¼ì… ì²´í¬ë¦¬ìŠ¤íŠ¸

ìƒˆ í´ë˜ìŠ¤ ì‘ì„± ì‹œ:
- [ ] @RequiredArgsConstructor ì‚¬ìš©í–ˆëŠ”ê°€?
- [ ] ëª¨ë“  ì˜ì¡´ì„± í•„ë“œë¥¼ finalë¡œ ì„ ì–¸í–ˆëŠ”ê°€?
- [ ] @Autowired í•„ë“œ ì£¼ì…ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ëŠ”ê°€?
- [ ] ìˆœí™˜ ì˜ì¡´ì„±ì´ ì—†ëŠ”ê°€?
- [ ] ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´í•˜ê³  ìˆëŠ”ê°€? (ê°€ëŠ¥í•œ ê²½ìš°)
- [ ] Bean ìŠ¤ì½”í”„ë¥¼ ì ì ˆíˆ ì„¤ì •í–ˆëŠ”ê°€?

## ğŸ¯ ì˜ì¡´ì„± ê´€ë¦¬ ëª¨ë²” ì‚¬ë¡€

### Interface ê¸°ë°˜ ì˜ì¡´ì„± (ê¶Œì¥)
```java
// ì¸í„°í˜ì´ìŠ¤ ì •ì˜
public interface NotificationService {
    void sendNotification(String to, String message);
}

// êµ¬í˜„ì²´
@Service
public class EmailNotificationService implements NotificationService {
    @Override
    public void sendNotification(String to, String message) {
        // ì´ë©”ì¼ ë°œì†¡ ë¡œì§
    }
}

// ì‚¬ìš©ì²˜ (ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´)
@Service
@RequiredArgsConstructor
public class UserService {
    private final NotificationService notificationService;  // ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
}
```

ì´ëŸ¬í•œ íŒ¨í„´ì„ ë”°ë¼ ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ê¸° ì‰¬ìš´ ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”.